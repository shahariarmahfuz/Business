{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    
    <!-- Left: Form -->
    <div class="lg:col-span-4 space-y-6">
        {% if edit_item %}
        <!-- Edit Form -->
        <div class="bg-yellow-50 p-5 rounded shadow border border-yellow-400 border-t-4">
            <h3 class="font-bold text-lg text-yellow-700 mb-3">বিক্রি সংশোধন (ID: {{ edit_item['id'] }})</h3>
            <form action="/update_sale/{{ edit_item['id'] }}" method="POST" class="space-y-3">
                <input type="date" name="sale_date" value="{{ edit_item['sale_date'] }}" required class="w-full border rounded p-2">
                <select name="category_id" required class="w-full border rounded p-2 bg-white">
                    {% for c in categories %}
                    <option value="{{ c['id'] }}" {{ 'selected' if c['id'] == edit_item['category_id'] else '' }}>{{ c['name'] }}</option>
                    {% endfor %}
                </select>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" step="0.01" name="rate" value="{{ edit_item['rate'] }}" placeholder="Rate" required class="border rounded p-2">
                    <input type="number" step="0.01" name="quantity" value="{{ edit_item['quantity'] }}" placeholder="Qty" required class="border rounded p-2">
                </div>
                <textarea name="description" class="w-full border rounded p-2 h-20">{{ edit_item['description'] }}</textarea>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">আপডেট</button>
                    <a href="/sales" class="px-4 py-2 bg-gray-300 rounded text-gray-700">বাতিল</a>
                </div>
            </form>
        </div>
        {% else %}
        <!-- Add Form -->
        <div class="bg-white p-5 rounded shadow border-t-4 border-green-500">
            <h3 class="font-bold text-lg text-slate-700 mb-3">নতুন বিক্রি</h3>
            <form action="/add_sale" method="POST" class="space-y-3">
                <input type="date" name="sale_date" value="{{ today }}" required class="w-full border rounded p-2 focus:border-green-500 outline-none">
                <div class="flex gap-2">
                    <select name="category_id" required class="flex-1 border rounded p-2 bg-white outline-none">
                        <option value="" disabled selected>চাল বাছুন...</option>
                        {% for c in categories %} 
                        <option value="{{ c['id'] }}">{{ c['name'] }}</option> 
                        {% endfor %}
                    </select>
                    <!-- Link to Category Page -->
                    <a href="/categories" class="bg-green-100 text-green-700 px-3 py-2 rounded border border-green-200 hover:bg-green-200" title="নতুন ক্যাটাগরি">+</a>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" step="0.01" id="rate" name="rate" placeholder="দর" required oninput="calcTotal()" class="border rounded p-2 outline-none">
                    <input type="number" step="0.01" id="qty" name="quantity" placeholder="পরিমাণ" required oninput="calcTotal()" class="border rounded p-2 outline-none">
                </div>
                <input type="number" id="total" readonly class="w-full bg-slate-100 border rounded p-2 font-bold text-green-700 text-center" placeholder="মোট টাকা">
                <textarea name="description" placeholder="বিবরণ (অপশনাল)" class="w-full border rounded p-2 outline-none h-16"></textarea>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">সেভ করুন</button>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Right: List -->
    <div class="lg:col-span-8">
        <div class="bg-white rounded shadow overflow-hidden">
            <!-- Filter -->
            <div class="bg-slate-50 p-4 border-b">
                <form method="GET" action="/sales" class="flex flex-wrap gap-2 items-end">
                    <div><label class="text-xs text-gray-500">তারিখ হতে</label><input type="date" name="start_date" value="{{ request.args.get('start_date','') }}" class="border rounded px-2 py-1 text-sm"></div>
                    <div><label class="text-xs text-gray-500">পর্যন্ত</label><input type="date" name="end_date" value="{{ request.args.get('end_date','') }}" class="border rounded px-2 py-1 text-sm"></div>
                    <div><label class="text-xs text-gray-500">চাল</label>
                        <select name="cat_filter" class="border rounded px-2 py-1 text-sm w-32">
                            <option value="">সব</option>
                            {% for c in categories %} <option value="{{ c['id'] }}" {{ 'selected' if request.args.get('cat_filter')|int == c['id'] else '' }}>{{ c['name'] }}</option> {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="bg-slate-700 text-white px-3 py-1 rounded text-sm h-8 mb-0.5">খুঁজুন</button>
                    <a href="/sales" class="text-red-500 text-sm ml-2 mb-1">Reset</a>
                </form>
            </div>

            <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 sticky top-0 shadow-sm">
                        <tr><th class="p-3">তারিখ</th><th class="p-3">নাম & বিবরণ</th><th class="p-3 text-right">হিসাব</th><th class="p-3 text-right">মোট</th><th class="p-3 text-center">Action</th></tr>
                    </thead>
                    <tbody class="divide-y">
                        {% for s in sales_data %}
                        <tr class="hover:bg-slate-50 group">
                            <td class="p-3 whitespace-nowrap">{{ s['sale_date'] }}</td>
                            <td class="p-3">
                                <div class="font-bold text-slate-700">{{ s['rice_name'] }}</div>
                                <div class="text-xs text-gray-500">{{ s['description'] if s['description'] else '' }}</div>
                            </td>
                            <td class="p-3 text-right text-xs text-gray-600">{{ s['rate'] }} x {{ s['quantity'] }}</td>
                            <td class="p-3 text-right font-bold text-green-700">৳ {{ "{:,.0f}".format(s['total_amount']) }}</td>
                            <td class="p-3 text-center">
                                <div class="flex justify-center gap-2 opacity-50 group-hover:opacity-100 transition">
                                    <a href="/sales?edit_id={{ s['id'] }}" class="text-blue-600"><i class="fa-solid fa-pen"></i></a>
                                    <a href="/delete_sale/{{ s['id'] }}" onclick="return confirm('মুছে ফেলতে চান?');" class="text-red-500"><i class="fa-solid fa-trash"></i></a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="p-8 text-center text-gray-400">কোনো তথ্য নেই</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function calcTotal() {
        let r = parseFloat(document.getElementById('rate').value) || 0;
        let q = parseFloat(document.getElementById('qty').value) || 0;
        document.getElementById('total').value = (r*q).toFixed(2);
    }
</script>
{% endblock %}